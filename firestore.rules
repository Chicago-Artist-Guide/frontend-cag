rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // AUTHENTICATION HELPER FUNCTIONS (from master)
    // ============================================

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check if user owns the account
    function ownsAccount(accountData) {
      return isAuthenticated() && request.auth.uid == accountData.uid;
    }

    // Helper function to check if user owns the profile
    function ownsProfile(profileData) {
      return isAuthenticated() && request.auth.uid == profileData.uid;
    }

    // Helper function to check if user is a theater company
    function isTheaterCompany(accountData) {
      return isAuthenticated() && accountData.type == 'company';
    }

    // Helper function to check if user is an individual talent
    function isIndividualTalent(accountData) {
      return isAuthenticated() && accountData.type == 'individual';
    }

    // ============================================
    // ADMIN HELPER FUNCTIONS
    // ============================================
    // Uses admin_users collection where document ID = user's auth UID
    // Roles hierarchy: super_admin > admin > moderator > staff

    function getAdminDoc() {
      return get(/databases/$(database)/documents/admin_users/$(request.auth.uid));
    }

    function hasAdminDoc() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
    }

    function getAdminRole() {
      return hasAdminDoc() ? getAdminDoc().data.role : null;
    }

    // Any admin role (staff, moderator, admin, super_admin)
    function isAdmin() {
      return hasAdminDoc() &&
        getAdminRole() in ['staff', 'moderator', 'admin', 'super_admin'];
    }

    // Staff or higher
    function isStaffOrHigher() {
      return hasAdminDoc() &&
        getAdminRole() in ['staff', 'moderator', 'admin', 'super_admin'];
    }

    // Moderator or higher
    function isModeratorOrHigher() {
      return hasAdminDoc() &&
        getAdminRole() in ['moderator', 'admin', 'super_admin'];
    }

    // Admin or higher
    function isAdminOrHigher() {
      return hasAdminDoc() &&
        getAdminRole() in ['admin', 'super_admin'];
    }

    // Super admin only
    function isSuperAdmin() {
      return hasAdminDoc() &&
        getAdminRole() == 'super_admin';
    }

    // ============================================
    // COLLECTION RULES
    // ============================================

    // Accounts collection
    // - Authenticated users can read
    // - Owners can write (create/update/delete their own)
    // - Admins can update any account (for user management)
    // - Only super_admin can modify admin_role field (prevents privilege escalation)
    // - Cannot modify your own admin_role (prevents self-escalation/accidental self-demotion)
    match /accounts/{accountId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid &&
        // New accounts cannot set admin_role
        !request.resource.data.keys().hasAny(['admin_role']);
      allow update: if isAuthenticated() && (
        // Owner can update their own account (but not admin_role)
        (request.auth.uid == resource.data.uid &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['admin_role'])) ||
        // Admins can update any account (but not admin_role)
        (isAdminOrHigher() &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['admin_role'])) ||
        // Only super_admin can modify admin_role, but not their own
        (isSuperAdmin() &&
         resource.data.uid != request.auth.uid)
      );
      allow delete: if isAuthenticated() &&
        request.auth.uid == resource.data.uid;
    }

    // Profiles collection
    // - Authenticated users can read
    // - Owners can write (create/update/delete their own)
    // - Admins can update any profile (for user management)
    match /profiles/{profileId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid;
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.uid ||
        isAdminOrHigher()
      );
      allow delete: if isAuthenticated() &&
        request.auth.uid == resource.data.uid;
    }

    // Productions collection
    // - Authenticated users can read
    // - Companies can create/update/delete their own productions
    match /productions/{productionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.account_id == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        resource.data.account_id == request.auth.uid;
    }

    // Events collection
    match /events/{eventId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() &&
        (resource == null || request.auth.uid == resource.data.uid);
    }

    // Threads collection
    match /threads/{threadId} {
      allow read, write: if isAuthenticated() &&
        (resource == null ||
         request.auth.uid in resource.data.participants ||
         request.auth.uid == resource.data.created_by);
    }

    // Messages collection
    match /messages/{messageId} {
      allow read, write: if isAuthenticated() &&
        (resource == null ||
         request.auth.uid == resource.data.sender_id ||
         request.auth.uid in resource.data.recipients);
    }

    // Mail collection
    match /mail/{mailId} {
      allow create: if true;
      allow read, update, delete: if isAuthenticated() &&
        (request.auth.uid == resource.data.to_user_id ||
         request.auth.uid == resource.data.from_user_id);
    }

    // Theater talent matches
    match /theater_talent_matches/{matchId} {
      allow read, write: if isAuthenticated();
    }

    // Public interests
    match /public_interests/{interestId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() &&
        (resource == null || request.auth.uid == resource.data.user_id);
    }

    // Theatre requests
    match /theatre_requests/{requestId} {
      allow create: if true;
      allow read, update, delete: if isAuthenticated() &&
        (resource == null || request.auth.uid == resource.data.user_id);
    }

    // ============================================
    // NEW COLLECTIONS
    // ============================================

    // Admin users collection
    // - Document ID must be the user's auth UID for rule lookups
    // - Only super_admins can manage admin users (prevents privilege escalation)
    // - Cannot modify your own admin_users doc (prevents self-escalation/accidental self-demotion)
    // - Bootstrap: First super_admin must be created manually in Firebase Console
    match /admin_users/{userId} {
      allow read: if isAuthenticated();
      // Super admin can create/update others' admin docs, but not their own
      allow create, update: if isSuperAdmin() &&
        userId != request.auth.uid &&
        request.resource.data.role in ['staff', 'moderator', 'admin', 'super_admin'];
      // Super admin can delete others' admin docs, but not their own
      allow delete: if isSuperAdmin() &&
        userId != request.auth.uid;
    }

    // Role opportunities collection (CAG job openings)
    // - Public read access (appears on /get-involved page)
    // - Authenticated users can create
    // - Owners can update/delete their own
    match /roleOpportunities/{roleId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() &&
        request.auth.uid == resource.data.account_id;
    }

    // Admin actions audit log - NEW
    // - Admins can read and create audit logs
    // - No updates allowed (tamper protection)
    // - No deletes (preserve audit trail)
    match /admin_actions/{actionId} {
      allow read: if isAdmin();
      allow create: if isAdmin() &&
        request.resource.data.keys().hasAll(['admin_uid', 'admin_email', 'action_type', 'target_type', 'target_id', 'timestamp']) &&
        request.resource.data.admin_uid == request.auth.uid &&
        request.resource.data.action_type in ['user_view', 'user_edit', 'company_approve', 'opening_view', 'opening_moderate', 'role_change', 'delete', 'export', 'profile_view', 'account_create'] &&
        request.resource.data.target_type in ['user', 'company', 'production', 'role', 'opening', 'match', 'theatre_request', 'account', 'profile'];
      allow update: if false;
      allow delete: if false;
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
